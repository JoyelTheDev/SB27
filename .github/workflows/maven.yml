name: Java CI

on:
  push:
    branches: [ master ]

permissions:
  contents: write   # REQUIRED to create GitHub releases

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0   # REQUIRED for git tags & changelog
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Build with Maven (skip tests)
      run: mvn -B package -DskipTests --file pom.xml
      env:
        MAVEN_OPTS: "--add-opens jdk.compiler/com.sun.tools.javac.api=ALL-UNNAMED --add-opens jdk.compiler/com.sun.tools.javac.code=ALL-UNNAMED --add-opens jdk.compiler/com.sun.tools.javac.comp=ALL-UNNAMED --add-opens jdk.compiler/com.sun.tools.javac.file=ALL-UNNAMED --add-opens jdk.compiler/com.sun.tools.javac.jvm=ALL-UNNAMED --add-opens jdk.compiler/com.sun.tools.javac.main=ALL-UNNAMED --add-opens jdk.compiler/com.sun.tools.javac.model=ALL-UNNAMED --add-opens jdk.compiler/com.sun.tools.javac.parser=ALL-UNNAMED --add-opens jdk.compiler/com.sun.tools.javac.processing=ALL-UNNAMED --add-opens jdk.compiler/com.sun.tools.javac.tree=ALL-UNNAMED --add-opens jdk.compiler/com.sun.tools.javac.util=ALL-UNNAMED"
    
    # -----------------------------
    # Find the built JAR
    # -----------------------------
    - name: Find JAR file
      run: |
        echo "ðŸ“¦ target directory contents:"
        ls -la obfuscator-core/target/
        
        JAR_FILE=$(ls obfuscator-core/target/obfuscator-core-*.jar \
          | grep -v original \
          | grep -v sources \
          | grep -v javadoc \
          | head -n 1)
        
        if [ -z "$JAR_FILE" ]; then
          echo "âŒ ERROR: No JAR file found"
          exit 1
        fi
        
        echo "âœ… Found JAR: $JAR_FILE"
        echo "JAR_FILE=$JAR_FILE" >> "$GITHUB_ENV"
        echo "JAR_NAME=$(basename "$JAR_FILE")" >> "$GITHUB_ENV"
    
    # -----------------------------
    # Generate changelog (since last tag)
    # -----------------------------
    - name: Generate changelog
      run: |
        LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
        echo "## Changes" > CHANGELOG.md
        
        if [ -z "$LAST_TAG" ]; then
          echo "_Initial release_" >> CHANGELOG.md
          git log --pretty=format:"- %s (%h)" >> CHANGELOG.md
        else
          echo "_Changes since $LAST_TAG_" >> CHANGELOG.md
          git log $LAST_TAG..HEAD --pretty=format:"- %s (%h)" >> CHANGELOG.md
        fi
    
    # -----------------------------
    # GitHub Release
    # -----------------------------
    - name: Upload to GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        files: ${{ env.JAR_FILE }}
        tag_name: v${{ github.run_number }}
        name: Obfuscator Build ${{ github.run_number }}
        body_path: CHANGELOG.md
        overwrite_files: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
